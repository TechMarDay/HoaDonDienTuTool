const getKey=async(e,t)=>{let a=await fetch("https://beautiful-fudge-8b4728.netlify.app/",{method:"GET",headers:{"Content-Type":"application/json"}});if(!a.ok)throw Error("Network response was not ok");return await a.text()};function showMessage(e,t,a){let n=document.getElementById(`${a}Message`);n.innerHTML=e,n.className=t}function openTab(e,t){let a=document.getElementsByClassName("tabcontent");for(let n=0;n<a.length;n++)a[n].style.display="none";let o=document.getElementsByClassName("tablinks");for(let s=0;s<o.length;s++)o[s].className=o[s].className.replace(" active","");document.getElementById(t).style.display="block",e.currentTarget.className+=" active"}let selectedFile;async function renameFiles(){try{if(!selectedFile){showMessage("Please select a ZIP file.","error");return}$("#loadingModal").modal("show");let e=await JSZip.loadAsync(selectedFile);for(let t in e.files)if(t.endsWith(".zip")){let a=await e.files[t].async("blob"),n=await JSZip.loadAsync(a),o=t.split(".zip")[0];for(let s in n.files){if(s.endsWith("invoice.html")){let l=await n.files[s].async("string");n.file(`${o}.html`,l),delete n.files[s]}if(s.endsWith("details.js")){let i=await n.files[s].async("string");n.file(`${o}.js`,i),delete n.files[s]}if(s.endsWith("invoice.xml")){let d=await n.files[s].async("string");n.file(`${o}.xml`,d),delete n.files[s]}if(s.endsWith("sign-check.jpg")){let r=await n.files[s].async("string");n.file(`${o}.html`,r),delete n.files[s]}if(s.endsWith("viewinvoice-bg.jpg")){let h=await n.files[s].async("string");n.file(`${o}.jpg`,h),delete n.files[s]}}await e.file(t,await n.generateAsync({type:"blob"}))}await e.generateAsync({type:"blob"}).then(e=>{saveAs(e,"invoice_files_renamed.zip")}),$("#loadingModal").modal("hide"),showMessage("Đổi t\xean file th\xe0nh c\xf4ng","success")}catch(c){console.error("Error:",c),$("#loadingModal").modal("hide"),handleError("Xảy ra lỗi khi đổi t\xean file, vui l\xf2ng thử lại")}}function showMessage(e,t){let a=document.getElementById("message");a.innerHTML=e,a.className=t}function formatDate(e,t){let a=new Date(e),n=(a.getMonth()+1).toString().padStart(2,"0"),o=a.getDate().toString().padStart(2,"0"),s=a.getFullYear().toString();return`${o}/${n}/${s}T${t?"00:00:00":"23:59:59"}`}function removeAccents(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"")}function formatDateInvoice(e){let t=new Date(e),a=String(t.getUTCDate()).padStart(2,"0"),n=String(t.getUTCMonth()+1).padStart(2,"0"),o=t.getUTCFullYear();return`${a}_${n}_${o}`}document.getElementById("fileInput").addEventListener("change",function(e){selectedFile=e.target.files[0]});let baseUrl="https://hoadondientu.gdt.gov.vn:30000/query/invoices/export-xml";const fetchAllPurchasedInvoicesData=async()=>{try{let e=localStorage.getItem("token"),t=document.getElementById("startDate").value,a=document.getElementById("endDate").value,n=formatDate(t,!0),o=formatDate(a),s=document.getElementById("kqkt").value,l=`https://hoadondientu.gdt.gov.vn:30000/query/invoices/purchase?sort=tdlap:desc,khmshdon:asc,shdon:desc&size=15&search=tdlap=ge=${n};tdlap=le=${o};ttxly==${s}`,i=1,d="";var r=await fetch(l,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{i=e.total,console.log(i)}).catch(e=>{handleError("Xảy ra lỗi khi tải h\xf3a đơn, vui l\xf2ng thử lại")});let h=`https://hoadondientu.gdt.gov.vn:30000/query/invoices/purchase?sort=tdlap:desc,khmshdon:asc,shdon:desc&size=50&search=tdlap=ge=${n};tdlap=le=${o};ttxly==${s}`,c=await fetch(h,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!c.ok)throw Error("Network response was not ok");let p=await c.json();d=p.state;let g=null,m=null,f="",u=[],w=[];if(null!=d&&""!=d&&(g=`https://hoadondientu.gdt.gov.vn:30000/query/invoices/purchase?sort=tdlap:desc,khmshdon:asc,shdon:desc&size=50&state=${d}&search=tdlap=ge=${n};tdlap=le=${o};ttxly==${s}`),g){let y=await fetch(g,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!y.ok)throw Error("Network response was not ok");if(f=(u=await y.json()).state,null!=f&&""!=f&&(m=`https://hoadondientu.gdt.gov.vn:30000/query/invoices/purchase?sort=tdlap:desc,khmshdon:asc,shdon:desc&size=50&state=${f}&search=tdlap=ge=${n};tdlap=le=${o};ttxly==${s}`),m){let k=await fetch(m,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!k.ok)throw Error("Network response was not ok");w=await k.json()}}let v=[...p.datas,...u.datas??[],...w.datas??[]],b=v.map(e=>({nbmst:e.nbmst,khhdon:e.khhdon,shdon:e.shdon,khmshdon:e.khmshdon,nbten:e.nbten,tdlap:e.tdlap})),E=b.map(e=>{let t=new URLSearchParams({nbmst:e.nbmst,khhdon:e.khhdon,shdon:e.shdon,khmshdon:e.khmshdon}),a=removeAccents(e.nbten),n=formatDateInvoice(e.tdlap);return{url:`${baseUrl}?${t.toString()}`,fileName:`${e.nbmst}_${a}_${e.shdon}_${n}`}});return E}catch(T){return handleError("Xảy ra lỗi khi tải h\xf3a đơn, vui l\xf2ng thử lại"),null}},fetchData=async(e,t)=>{let a=await fetch(e,{method:"GET",headers:{Authorization:`Bearer ${t}`}});return a.ok,a.blob()},fetchAndZipFilesForPurchasedInvoices=async()=>{try{$("#loadingModal1").modal("show");let e=localStorage.getItem("token"),t=await fetchAllPurchasedInvoicesData(),a=new JSZip;t.length;let n=1;for(let o of t){let s=await fetchData(o.url,e);a.file(`${n}_${o.fileName}.zip`,s),n++}let l=await a.generateAsync({type:"blob"}),i=document.createElement("a");i.href=URL.createObjectURL(l),i.download="invoice_files.zip",document.body.appendChild(i),i.click(),document.body.removeChild(i),$("#loadingModal1").modal("hide")}catch(d){console.error("Error:",d),$("#loadingModal1").modal("hide"),handleError("Xảy ra lỗi khi tải h\xf3a đơn, vui l\xf2ng thử lại")}},fetchAllSoldInvoicesData=async()=>{try{let e=localStorage.getItem("token"),t=document.getElementById("startDatesold").value,a=document.getElementById("endDatesold").value,n=formatDate(t,!0),o=formatDate(a),s=`https://hoadondientu.gdt.gov.vn:30000/query/invoices/sold?sort=tdlap:desc,khmshdon:asc,shdon:desc&size=15&search=tdlap=ge=${n};tdlap=le=${o}`,l=1,i="";var d=await fetch(s,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{l=e.total,console.log(l)}).catch(e=>{console.error("Error fetching data:",e),handleError("Xảy ra lỗi khi tải h\xf3a đơn, vui l\xf2ng thử lại")});let r=`https://hoadondientu.gdt.gov.vn:30000/query/invoices/sold?sort=tdlap:desc,khmshdon:asc,shdon:desc&size=50&search=tdlap=ge=${n};tdlap=le=${o}`,h=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!h.ok)throw Error("Network response was not ok");let c=await h.json();i=c.state;let p=null,g=null,m="",f=[],u=[];if(null!=i&&""!=i&&(p=`https://hoadondientu.gdt.gov.vn:30000/query/invoices/sold?sort=tdlap:desc,khmshdon:asc,shdon:desc&size=50&state=${i}&search=tdlap=ge=${n};tdlap=le=${o}`),p){let w=await fetch(p,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!w.ok)throw Error("Network response was not ok");if(m=(f=await w.json()).state,null!=m&&""!=m&&(g=`https://hoadondientu.gdt.gov.vn:30000/query/invoices/sold?sort=tdlap:desc,khmshdon:asc,shdon:desc&size=50&state=${m}&search=tdlap=ge=${n};tdlap=le=${o}`),g){let y=await fetch(g,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!y.ok)throw Error("Network response was not ok");u=await y.json()}}let k=[...c.datas,...f.datas??[],...u.datas??[]],v=k.map(e=>({nbmst:e.nbmst,khhdon:e.khhdon,shdon:e.shdon,khmshdon:e.khmshdon,nbten:e.nbten,tdlap:e.tdlap})),b=v.map(e=>{let t=new URLSearchParams({nbmst:e.nbmst,khhdon:e.khhdon,shdon:e.shdon,khmshdon:e.khmshdon}),a=removeAccents(e.nbten),n=formatDateInvoice(e.tdlap);return{url:`${baseUrl}?${t.toString()}`,fileName:`${e.nbmst}_${a}_${e.shdon}_${n}`}});return b}catch(E){return console.error("There was a problem with the request:",E),handleError("Xảy ra lỗi khi tải h\xf3a đơn, vui l\xf2ng thử lại"),null}},fetchAndZipFilesForSoldInvoices=async()=>{try{$("#loadingModal2").modal("show");let e=localStorage.getItem("token"),t=await fetchAllSoldInvoicesData(),a=new JSZip;t.length;let n=1;for(let o of t){let s=await fetchData(o.url,e);a.file(`${n}_${o.fileName}.zip`,s),n++}let l=await a.generateAsync({type:"blob"}),i=document.createElement("a");i.href=URL.createObjectURL(l),i.download="invoice_files.zip",document.body.appendChild(i),i.click(),document.body.removeChild(i),$("#loadingModal2").modal("hide")}catch(d){console.error("Error:",d),$("#loadingModal2").modal("hide"),handleError("Xảy ra lỗi khi tải h\xf3a đơn, vui l\xf2ng thử lại")}};